# Predator Analytics 2.0 - Система анализа таможенных деклараций

## Назначение системы

Predator Analytics 2.0 представляет собой аналитическую систему для обработки и анализа больших массивов таможенных деклараций. Система использует комбинацию реляционной базы данных PostgreSQL для структурированных запросов и OpenSearch для векторного поиска, обеспечивая возможность аналитики с использованием языковых моделей через Ollama.

## Архитектура системы

### Компоненты системы:

1. **API Server (Flask)** - основной сервер, обрабатывающий запросы и взаимодействующий с базами данных
2. **PostgreSQL** - хранение структурированных таможенных данных
3. **OpenSearch** - векторное хранилище для семантического поиска
4. **Redis** - кэширование результатов запросов
5. **Open WebUI** - веб-интерфейс для взаимодействия с системой
6. **Ollama** - локальный сервис для запуска языковых моделей

### Структура проекта:

## Основной функционал

### 1. Импорт и индексация данных

Система поддерживает импорт данных из CSV и Excel файлов с таможенными декларациями. При импорте происходит:
- Преобразование Excel в CSV при необходимости
- Очистка и нормализация данных
- Параллельная загрузка в PostgreSQL и OpenSearch
- Векторизация текстовых полей для семантического поиска

### 2. API для запросов и аналитики

API сервер предоставляет следующие эндпоинты:
- `/index_csv` - индексация CSV файлов
- `/api/chat` и `/process_query` - обработка запросов с использованием LLM
- `/api/models` и `/api/tags` - информация о доступных моделях
- `/upload_document` - загрузка документов других форматов (PDF, Word и т.д.)
- `/convert_excel_to_csv_from_data` - конвертация Excel в CSV
- `/health` - проверка статуса сервиса

### 3. Ретривал-аугментированная генерация (RAG)

Система использует RAG-подход:
1. Запрос пользователя векторизуется
2. Выполняется поиск по векторному и реляционному хранилищам
3. Релевантные документы извлекаются и сокращаются до максимального контекста
4. LLM генерирует ответ на основе найденного контекста
5. Ответ кэшируется в Redis для повышения производительности

## Технические особенности

- **Асинхронность**: использование `asyncpg` для асинхронного взаимодействия с PostgreSQL
- **Отказоустойчивость**: механизм повторных попыток с использованием `tenacity`
- **Потоковая передача**: поддержка streaming ответов через Open WebUI
- **Совместимость с OpenAI API**: интеграция с интерфейсами, ожидающими OpenAI-совместимые ответы
- **Масштабируемость**: параллельная обработка данных, возможность настройки количества рабочих потоков
- **Оптимизированное хранение**: индексы для ускорения поиска в PostgreSQL

## Процесс развертывания

1. Настройка переменных окружения в .env
2. Запуск системы через `docker-compose up -d`
3. Инициализация базы данных с помощью скрипта init.sql
4. Импорт данных из CSV/Excel файлов
5. Доступ к интерфейсу Open WebUI через `http://localhost:3000`

## Использование системы

Пользователь может:
- Загружать файлы с таможенными декларациями для анализа
- Задавать вопросы на естественном языке через веб-интерфейс
- Получать аналитические ответы, основанные на данных из деклараций
- Конвертировать Excel в CSV для дальнейшего анализа

## Заключение

Predator Analytics 2.0 представляет собой комплексное решение для анализа таможенных деклараций, сочетающее традиционные методы хранения данных с современными подходами векторного поиска и обработки естественного языка. Система организована как набор микросервисов, взаимодействующих через Docker Compose, что обеспечивает гибкость развертывания и масштабирования.