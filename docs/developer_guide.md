# Developer Guide for Predator Analytics 2.0

## 1. Загальний огляд
Predator Analytics 2.0 — аналітична система моніторингу та прогнозування митних схем, розроблена для обробки багатомільйонних масивів митних декларацій у форматі JSON. Основні дані одночасно зберігаються в OpenSearch для векторного пошуку та в PostgreSQL для виконання SQL-запитів.

### Основна стратегічна мета
Забезпечення максимально швидкої та точної відповіді на запити користувачів, які надходять від користувацького інтерфейсу Open WebUI (фронтенд) до API-сервера (бекенд) по даних митних декларацій, що одночасно зберігаються у PostgreSQL для SQL-запитів та в OpenSearch для векторного пошуку та аналітики.

---

## 2. Компоненти системи

### 2.1 Open WebUI (Frontend)
- Користувацький інтерфейс для клієнтів, аналітиків та брокерів.
- Відправляє запити на API Server.
- Отримує аналітичні відповіді та результати обробки.

### 2.2 API Server (Backend)
- Приймає запити від Open WebUI.
- Обробляє їх та передає до LangChain Service.
- Отримує дані з PostgreSQL та OpenSearch.
- Логує всі запити та відповіді у PostgreSQL (query_log).
- Кешує результати у Redis.

### 2.3 LangChain Service
- Векторизація текстових запитів через Ollama.
- Векторний пошук у OpenSearch.
- Побудова аналітичної відповіді через RetrievalQA.
- Підтримка обробки документів (PDF, зображення, Word) через Unstructured Loaders.
- Окремий промпт-аналітик: "Ти аналітик митних схем та фінансових махінацій..."

### 2.4 PostgreSQL
- Основна база для зберігання структурованих даних митних декларацій.
- Логування всіх запитів користувачів у таблицю query_log.
- Оптимізовані індекси на основні поля (дата, номер МД, код товару).
- Використовується для SQL-запитів при формуванні відповідей.

### 2.5 OpenSearch
- Основне сховище для векторизованих документів та декларацій.
- Підтримує векторний пошук через LangChain.
- Індекс: customs_data.
- Поля залишаються стабільними та статичними.
- Пакетна індексація при завантаженні нових даних.

### 2.6 Redis
- Кешування відповідей для прискорення повторних запитів.
- Формат ключів: query_cache:<запит>.
- Термін життя кешу: 1 година.

### 2.7 Data Ingestion Service
- Окремий сервіс для масового завантаження даних.
- Паралельна обробка (за замовчуванням — кількість фізичних ядер Mac Studio M1 Max).
- Можливість вручну задати кількість потоків.
- Логування процесу та помилок.
- Обробка пакетами по 1000 записів у PostgreSQL та OpenSearch.

---

## 3. Моніторинг та контроль
- Всі ключові дії (обробка, імпорт, помилки) логуються через logging.
- Логи доступні для зовнішньої інтеграції (Prometheus або Zabbix у майбутньому).
- Обов'язковий контроль через системний лог під час кожного процесу завантаження та обробки.

---

## 4. Процес оновлення та управління змінами

### Загальні правила
- Кожна зміна в коді чи конфігурації повинна бути зафіксована в цьому файлі.
- Зміни вносяться лише після підтвердження користувачем через формат:
    1. **Затверджуєш?** — після пропозиції змін.
    2. Після підтвердження — внесення змін у код.
    3. Аналіз залежностей — чи треба змінювати інші компоненти.
    4. **Затверджуєш додаткові зміни?** — після аналізу.
    5. Після остаточного підтвердження — зміни фіксуються у цьому файлі з точним описом.

### Приклад фіксації змін
> Підключається до MariaDB для отримання додаткових даних замість PostgreSQL. Зміни внесені у компоненти: API Server, LangChain Service, Data Ingestion Service. Всі залежні функції перевірено, додаткові зміни не потрібні. Зміни проведені, структура відповідає стратегічній цілі.

---

## 5. Актуальний принцип побудови системи

> Основний принцип побудови системи — миттєва аналітика на основі поєднання SQL-запитів та векторного пошуку через OpenSearch. Система забезпечує максимально швидку та точну відповідь на запити користувача, які надходять від користувацького інтерфейсу Open WebUI (фронтенд) до API-сервера (бекенд). Запити стосуються даних митних декларацій, що одночасно зберігаються у PostgreSQL для структурованих SQL-запитів та в OpenSearch для векторного пошуку та аналітики.

---

## 6. Файли проекту та їх призначення

| Файл                         | Опис |
|--------------------|-----------------|
| **developer_guide.md** | Актуальна документація для розробників. Координатор точності. |
| **import_to_opensearch_pg.py** | Масовий імпорт даних у PostgreSQL та OpenSearch з підтримкою потоків. |
| **docker-compose.yml** | Контейнеризація всіх компонентів системи. |
| **langchain/app.py** | Логіка обробки запитів через LangChain. |
| **apiserver/app.py** | Логіка API для взаємодії з Open WebUI. |
| **init.sql** | Скрипт створення таблиць customs_data та query_log. |

---

