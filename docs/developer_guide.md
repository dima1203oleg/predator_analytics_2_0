# Developer Guide for Predator Analytics 2.0 (v1.0)

## 1. Загальний огляд
Predator Analytics 2.0 — аналітична система для обробки багатомільйонних масивів митних декларацій у форматі JSON. Основні дані одночасно зберігаються в OpenSearch для векторного пошуку та в PostgreSQL для SQL-запитів.

### Основна стратегічна мета
Забезпечення максимально швидкої та точної відповіді на запити користувачів, які надходять від Open WebUI до API-сервера по даних митних декларацій, що зберігаються у PostgreSQL для SQL-запитів та в OpenSearch для векторного пошуку та аналітики.

---

## 2. Компоненти системи

### 2.1 Open WebUI (Frontend)
- Користувацький інтерфейс для введення запитів.
- Відправляє запити на API Server.

### 2.2 API Server (Backend)
- Обробляє запити від Open WebUI асинхронно.
- Виконує векторний пошук у OpenSearch та SQL-запити до PostgreSQL.
- Кешує результати у Redis.
- Використовує retry-логіку для стійкості до збоїв.

### 2.3 LangChain Service
- Векторизація запитів через Ollama.
- Векторний пошук у OpenSearch.
- Формування аналітичних відповідей через RetrievalQA.

### 2.4 PostgreSQL
- Зберігання структурованих даних митних декларацій.
- Оптимізовані індекси на ключові поля.
- Логування запитів у таблицю `query_log`.

### 2.5 OpenSearch
- Векторний пошук і зберігання декларацій.
- Індекс: `customs_data`.

### 2.6 Redis
- Кешування відповідей.
- TTL: 1 година.

### 2.7 Data Ingestion Service
- Масове завантаження даних у PostgreSQL та OpenSearch.
- Паралельна обробка з оптимізованою кількістю потоків.
- Retry-логіка для стійкості до збоїв.

---

## 3. Файли проекту

| Файл                         | Опис |
|------------------------------|------|
| **developer_guide.md**       | Документація для розробників. |
| **import_to_opensearch_pg.py** | Імпорт даних у PostgreSQL та OpenSearch. |
| **docker-compose.yml**       | Контейнеризація системи. |
| **apiserver/app.py**         | Логіка API-сервера. |
| **init.sql**                 | Скрипт створення таблиць. |

---

## 4. Зміни у v1.0
- Видалено моніторинг (Grafana, Loki, Prometheus тощо).
- Оптимізовано для швидкості: індекси в PostgreSQL, більші пакети в OpenSearch, паралельність у завантаженні.
- Додано комбінований пошук (OpenSearch + SQL) для точності.
- Впроваджено асинхронність у API-сервері через `asyncpg`.
- Додано retry-логіку через `tenacity` для підключень до баз даних та Ollama.